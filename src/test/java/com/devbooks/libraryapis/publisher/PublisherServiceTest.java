package com.devbooks.libraryapis.publisher;

import com.devbooks.libraryapis.exception.LibraryResourceAlreadyExistsException;
import com.devbooks.libraryapis.exception.LibraryResourceNotFoundException;
import com.devbooks.libraryapis.testutils.LibraryApiTestUtil;
import com.devbooks.libraryapis.testutils.TestConstants;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.EmptyResultDataAccessException;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@RunWith(MockitoJUnitRunner.class)
public class PublisherServiceTest {

    @Mock
    PublisherRepository publisherRepository;

    PublisherService publisherService;
    private Object DataIntegrityViolationException;

    @Before
    public void setUp() throws Exception {
        publisherService = new PublisherService(publisherRepository);
    }

    @After
    public void tearDown() throws Exception {
    }

    @Test
    public void addPublisher_success() throws LibraryResourceAlreadyExistsException {
        when(publisherRepository.save(any(PublisherEntity.class)))
                .thenReturn(LibraryApiTestUtil.createPublisherEntity());
        Publisher publisher = LibraryApiTestUtil.createPublisher();
        publisherService.addPublisher(publisher, TestConstants.API_TRACE_ID);

//        verify save method is called
        verify(publisherRepository, times(1)).save(any(PublisherEntity.class));
        assertNotNull(publisher.getPublisherId());
        assertTrue(publisher.getName().equals(TestConstants.TEST_PUBLISHER_NAME));
    }

    @Test(expected = LibraryResourceAlreadyExistsException.class)
    public void addPublisher_failure() throws LibraryResourceAlreadyExistsException {

        doThrow(DataIntegrityViolationException.class).when(publisherRepository).save(any(PublisherEntity.class));
        Publisher publisher = LibraryApiTestUtil.createPublisher();
        publisherService.addPublisher(publisher, TestConstants.API_TRACE_ID);

//        verify save method is called
        verify(publisherRepository, times(1)).save(any(PublisherEntity.class));

    }

    @Test
    public void getPublisher_success() throws LibraryResourceNotFoundException {

        when(publisherRepository.findById(anyInt()))
                .thenReturn(LibraryApiTestUtil.createPublisherEntityOptional());
        Publisher publisher = publisherService.getPublisher(123, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).findById(123);
        assertNotNull(publisher.getPublisherId());
        assertNotNull(publisher);

    }

    @Test(expected = LibraryResourceNotFoundException.class)
    public void getPublisher_failure() throws LibraryResourceNotFoundException {

        when(publisherRepository.findById(anyInt()))
                .thenReturn(Optional.empty());
        publisherService.getPublisher(123, TestConstants.API_TRACE_ID);
        verify(publisherRepository, times(1)).findById(123);

    }

    @Test
    public void updatePublisher_success() throws LibraryResourceAlreadyExistsException, LibraryResourceNotFoundException {
        when(publisherRepository.save(any(PublisherEntity.class)))
                .thenReturn(LibraryApiTestUtil.createPublisherEntity());
        Publisher publisher = LibraryApiTestUtil.createPublisher();
        publisherService.addPublisher(publisher, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).save(any(PublisherEntity.class));

        publisher.setEmailId(TestConstants.TEST_PUBLISHER_EMAIL_UPDATED);
        publisher.setPhoneNumber(TestConstants.TEST_PUBLISHER_PHONE_UPDATED);

        when(publisherRepository.findById(anyInt()))
                .thenReturn(LibraryApiTestUtil.createPublisherEntityOptional());
        publisherService.updatePublisher(publisher, TestConstants.API_TRACE_ID);

         verify(publisherRepository, times(1)).findById(publisher.getPublisherId());
        verify(publisherRepository, times(2)).save(any(PublisherEntity.class));
        assertTrue(TestConstants.TEST_PUBLISHER_EMAIL_UPDATED.equals(publisher.getEmailId()));
        assertTrue(TestConstants.TEST_PUBLISHER_PHONE_UPDATED.equals(publisher.getPhoneNumber()));


    }

    @Test
    public void deletePublisher_success() throws LibraryResourceNotFoundException {

        doNothing().when(publisherRepository).deleteById(123);
        publisherService.deletePublisher(123, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).deleteById(123);

    }

    @Test(expected = LibraryResourceNotFoundException.class)
    public void deletePublisher_failure() throws LibraryResourceNotFoundException {

        doThrow(EmptyResultDataAccessException.class).when(publisherRepository).deleteById(123);

        publisherService.deletePublisher(123, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).deleteById(123);

    }

    @Test
    public void searchPublisher_success() {

        List<PublisherEntity> publisherEntityList = Arrays.asList(
                new PublisherEntity(TestConstants.TEST_PUBLISHER_NAME + 1,
                        TestConstants.TEST_PUBLISHER_EMAIL,
                        TestConstants.TEST_PUBLISHER_PHONE),
                new PublisherEntity(TestConstants.TEST_PUBLISHER_NAME + 2,
                        TestConstants.TEST_PUBLISHER_EMAIL,
                        TestConstants.TEST_PUBLISHER_PHONE)
        );
        when(publisherRepository.findByNameContaining(TestConstants.TEST_PUBLISHER_NAME))
                .thenReturn(publisherEntityList);

        List<Publisher> publishers = publisherService.searchPublisher(TestConstants.TEST_PUBLISHER_NAME, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).findByNameContaining(TestConstants.TEST_PUBLISHER_NAME);

        assertEquals(publisherEntityList.size(), publishers.size());

        assertEquals(publisherEntityList.size(), publishers.stream()
            .filter(publisher -> publisher.getName().contains(TestConstants.TEST_PUBLISHER_NAME))
                .count()
        );
    }

    @Test
    public void searchPublisher_failure() {

        when(publisherRepository.findByNameContaining(TestConstants.TEST_PUBLISHER_NAME))
                .thenReturn(Collections.emptyList());

        List<Publisher> publishers = publisherService.searchPublisher(TestConstants.TEST_PUBLISHER_NAME, TestConstants.API_TRACE_ID);

        verify(publisherRepository, times(1)).findByNameContaining(TestConstants.TEST_PUBLISHER_NAME);
        assertEquals(0, publishers.size());
    }
}